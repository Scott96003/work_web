
<!-- 更新日期 2023/9/5 -->
<!-- saved from url=(0070)https://dlcd.testtz886.net/tsdl.html?v=303%2526t&t=&s=&time=1691471025 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Document</title>
    <style>
        .ttt {
            text-align: justify;
            text-align-last: justify;
            width: 80px;
        }
        .tdText {
            text-align: right;
            text-align-last: right;
            width: 100px;
        }
        table {
            /* max-width: 440px; */
        }
    </style>

</head>
<script src="https://code.jquery.com/jquery-3.7.1.slim.min.js" integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
<body>
    <center>
        <p>ver 0001</p>
        <div>
            <table style="table-layout:fixed;">
                <tbody>                
                <tr>
                    <td class="ttt">
                        版本號
                    </td>

                    <td class="tdText">
                        <input id="app_version" value="1" onchange="clic()" style="width:100%;">
                    </td>
                </tr>
                <tr>
                    <td class="ttt">
                        分站
                    </td>
                    <td class="tdText">
                        <select id="app_site" onchange="clic()" style="width:100%;">
                            <option value="16">海1</option>
                            <option value="18">海2</option>
                            <option value="19">海3</option>
                            <option value="20">海4</option>
                            <option value="21">山1</option>
                            <option value="2">山2</option>
                            <option value="26">山3</option>
                            <option value="35">山4</option>
                            <option value="5">山5</option>
                        </select>
                    </td>
                </tr>
                    <td class="ttt">
                        測試區域
                    </td>
                    <td class="tdText">
                        <select id="app_type" onchange="clic()" style="width:100%;">
                            <option value="dev">測試站</option>
                            <option value="uat">前測站</option>
                            <option value="release">正式站</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="ttt">
                        使用憑證
                    </td>
                    <td class="tdText">
                        <select id="appAccount" onchange="clic()" style="width:100%;">
                            <option value="">預設憑證</option>
                            <option value="reyesannenzrn@icloud.com">新憑證</option>
                        </select>
                    </td>
                </tr>

            </tbody></table>

        </div>

        <br>

        <!-- 
		<button onclick="clic()">產生下載連結</button></br>
		-->
        <!-- 連結內容 -->
        <div id="download_list"><span>請點選線路下載 LEO 21站 測試站 版本:303%2526t</span><br><br><a href="itms-services://?action=download-manifest&amp;url=itms-services://?action=download-manifest&amp;url=https://dlin.testtz886.net/appVersion/iosVersion/21/303%2526t/ts_dlin.testtz886.net.plist">dlin.testtz886.net</a><br><br><br><a href="itms-services://?action=download-manifest&amp;url=itms-services://?action=download-manifest&amp;url=https://dlcd.testtz886.net/appVersion/iosVersion/21/303%2526t/ts_dlcd.testtz886.net.plist">dlcd.testtz886.net</a><br></div>
    </center>



    <script type="text/javascript">

        ///取得目前的時間戳
        const dateTime = Date.now();
        const timestamp = Math.floor(dateTime / 1000);
        console.log('目前系統的時間戳', timestamp);
        if (checkTimestamp(5) == true) {
            ///啟動eruda
            setInput()
            clic()
        } else {
            console.log("時間戳超過使用期限, 重新載入")
            var version = getArgs("v");
            var type = getArgs("t");
            var site = getArgs("s");
            var assign_acc_id = decodeURIComponent(getArgs("aai")); //放入特定的憑證帳號

            var url = new URL(window.location.href);
            url.searchParams.set('v', version);
            url.searchParams.set('t', type);
            url.searchParams.set('s', site);
            url.searchParams.set('aai', assign_acc_id);
            url.searchParams.set('time', timestamp);
            window.location.href = url.href;
        }


        ///檢查時間戳, 超過5秒重新載入
        function checkTimestamp(ck_time) {
            if (ck_time) {
                
            } else {
                console.log("checktime 沒給值使用預設5");
                ck_time = 5
            }
            var time = getArgs("time");
            if (time == undefined) {
                return false
            } else {
                var t = parseInt(time) + 5;
                if (isNaN(t)) {
                    return false
                }
                return (timestamp < t);
            }
        }

        ///設定輸入
        function setInput() {
            var version = getArgs("v");
            var type = getArgs("t");
            var site = getArgs("s");
            var time = getArgs("time");
            var assign_acc_id = decodeURIComponent(getArgs("aai")); //放入特定的憑證帳號
            console.log('參數接收的時間戳', time);

            //將傳入的參數放入到選項中
            document.getElementById("app_version").value = version || 1;
            document.getElementById("app_type").value = type || "dev";
            document.getElementById("app_site").value = site || "21";
            //如果有傳入指定憑證帳號, 增加option並選定
            if (assign_acc_id) {
                jQuery("#appAccount").append(new Option(assign_acc_id,assign_acc_id));
                jQuery("#appAccount").val(assign_acc_id).change();
            } else {
                document.getElementById("appAccount").value = "";
            }
            
            
        }

        function getArgs(key) {
            var url = window.location.toString();

            if (url.indexOf("?") != -1) {
                var ary = url.split("?")[1].split("&");

                for (var i in ary) {
                    var keyValue = ary[i].split("=")
                    if (keyValue[0] == key) {
                        return keyValue[1]
                    }
                }
            }
            return ""
        }

        //更換變數的時候
        function clic() {
            var assign_acc_id = getArgs("aai");

            var version = document.getElementById("app_version").value;
            var typeObj = document.getElementById("app_type");
            var langObj = document.getElementById("app_site");
            var appAcc = document.getElementById("appAccount");
            var type = typeObj.value;
            var typeName = typeObj[typeObj.selectedIndex].text;
            var site = langObj.value;
            var siteName = langObj[langObj.selectedIndex].text;
            var app_acc_id = appAcc.value;
            var app_acc_text = appAcc[appAcc.selectedIndex].text;

            
            console.log("assign_acc_id=" + assign_acc_id);
            console.log("siteName:", site);            
            console.log("type:", type);

            document.getElementById("download_list").innerHTML = "<span>請點選線路下載<br>" + typeName + " " + siteName + " 版本:" + version + "</span>";
            var domains = getDomains(type, site, version)

            for (var x = 0; x < domains.length; x++) {
                let path = domains[x].path
                let hosts = domains[x].hosts
                for (var y = 0; y < hosts.length; y++) {
                    let url = hosts[y]

                    if (app_acc_id == "") {
                        const account = "ququ200901"
                        // 在按鈕的 onclick 事件中呼叫 generatePlist 並傳遞參數
                        document.getElementById("download_list").innerHTML += "<br/><br/><button onclick='generatePlist(\"" + account + "\", " + site + ", \"" + version + "\", \"" + url + "\", \"" + type + "\")'>" + url + "</button><br/>";
                    } else {
                        // 在按鈕的 onclick 事件中呼叫 generatePlist 並傳遞參數
                        document.getElementById("download_list").innerHTML += "<br/><br/><button onclick='downloadPlist(\"" + app_acc_id + "\", " + site + ", \"" + version + "\", \"" + url + "\", \"" + type + "\")'>" + url + "</button><br/>";
                        
                        /* 此為之前的下載方法
                        var newPath = "/appVersion/iosVersion/" + site + "/" + version + "/"+app_acc_id+"_";

                        document.getElementById("download_list").innerHTML += "<br/><br/><a href=\"itms-services://?action=download-manifest&amp;url=itms-services://?action=download-manifest&amp;url=https://" + url + newPath + url + ".plist\">" + url + "</a><br/>"
                        */



                        /* 此方法先暫時不用, 因為動態plist只會使用最新版本的版號

                        //下載參數, 判斷是否有指定憑證
                        if (assign_acc_id) {
                            var queryString = plist_get_querystring(type,site,assign_acc_id);                            
                        } else {
                            var queryString = plist_get_querystring(type,site,app_acc_id);
                        }
                        console.log("queryString="+queryString)
                        //編碼後才可以放入
                        var auto_plist_url = encodeURIComponent("https://" + url + "/PlistInstall.ashx" + queryString);
                        document.getElementById("download_list").innerHTML += "<br/><br/><a href=\"itms-services://?action=download-manifest&amp;url=itms-services://?action=download-manifest&amp;url=" + auto_plist_url + "\">" + app_acc_text + "-" +url + "</a><br/>"
                        */
                    }                
                }
            }
        }

        function getDomains(type, site, version) {
            let domains = []
            // 2022 10/7 更新
            let domains_cntw = [
                "d.mbd16in.net",
                "d.mbd66cd.net",
                "d.mbd66tf.net",
                "dcc.minghaomuye.com",
                "d.mbd16obs.net",
                "d.mbd16ni.net"]
            let domains_vi = [
                "d.mbd18in.net",
                "d.mbd18cd.net",
                "d.mbd18tf.net",
                "d.mbd18obs.net"]
            let domains_th = [
                "d.mbd19in.net",
                "d.mbd19cd.net",
                "d.mbd19tf.net",
                "d.mbd19cf.net",
                "d.mbd19obs.net"]
            let domains_id = [
                "d.mbd20in.net",
                "d.mbd20cd.net",
                "d.mbd20tf.net",
                "d.mbd20obs.net"]
            if (type == "uat") {
                switch (site) {
                case "16":
                case "18":
                case "19":
                case "20":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": ["uatdl.tz886in.net",
                              "uatdl.tz886cd.net",
                              "uatdl.tz886sp.net",
                              "uatdl.tz886cf.net",
                              "uatdl.tz886tf.net",
                              "uatdl.tz886ws.net"]
                        }
                        ]
                    break;
                default:
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ts_",
                            "hosts": ["uatdl.tz886in.net",
                              "uatdl.tz886cd.net",
                              "uatdl.tz886sp.net",
                              "uatdl.tz886cf.net",
                              "uatdl.tz886tf.net",
                              "uatdl.tz886ws.net"]
                        }
                        ]
                }
                return domains
            } else if (type == "release") {
                switch (site) {
                case "16":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": domains_cntw
                        }
                        ]
                    break;
				case "2": case "21": case "26": case "35": 
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ts_",
                            "hosts": domains_cntw
                        }
                        ]
                    break;
				case "18":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": domains_vi
                        }
                        ]
                    break;
				case "5":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ts_",
                            "hosts": domains_vi
                        }
                        ]
                    break;
				case "19":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": domains_th
                        }
                        ]
                    break;
                case "20":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": domains_id
                        }
                        ]
                    break;
                default:
                domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ts_",
                            "hosts": []
                        }
                        ]
                }
                return domains
            } else {
                switch (site) {
                case "16":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": ["dlin.testtz886.net", "dlcd.testtz886.net"]
                        }
                        ]
                    break;
                case "18":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": ["dlin.testtz886.net", "dlcd.testtz886.net"]
                        }
                        ]              
                    break;
                case "19":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": ["dlin.testtz886.net", "dlcd.testtz886.net"]
                        }
                        ]
                    break;
                case "20":
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ku_",
                            "hosts": ["dlin.testtz886.net", "dlcd.testtz886.net"]
                        }
                        ]
                    break;
                default:
                    domains = [
                        {
                            "path": "/appVersion/iosVersion/" + site + "/" + version + "/ts_",
                            "hosts": ["dlin.testtz886.net", "dlcd.testtz886.net"]
                        }
                        ]
                }
                return domains
            }
            
        }

        // 取得 plist k 值
        function plist_get_querystring(type,site,acc) {
            console.log("使用特定憑證:" + acc);
            //取得 k 值
            var plist_k = ""
            if (type == "dev") {
                // 測試站
                switch (site) {
                    case "16":
                        plist_k = "D869AB46BC91C065A91034551B842BDA";
                        break;
                    case "18":
                        plist_k = "A779652626F0FA7CBE9FFF1B22F9A795";
                        break;
                    case "19":
                        plist_k = "A4DD7F43E860C5A7F1E9B352687A4938";
                        break;
                    case "20":
                        plist_k = "D2978E837C03D1F3BF7E3D947E7E7E92";
                        break;
                    case "21":
                        plist_k = "32AD3597A3E87A106579938F58652FD8";
                        break;
                    case "2":
                        plist_k = "9E5A5736B8834B79B10CA4CE7562F019";
                        break;
                    case "26":
                        plist_k = "598DF6DFB9239FA27CAE4A086995C161";
                        break;
                    case "35":
                        plist_k = "19C3085301FE244F9B1D3DB399E3D4B9";
                        break;
                    case "5":
                        plist_k = "2C189894458F78493245F1CC6DDA68AD";
                        break;
                }
            } else {
                // 正式站 前測
                switch (site) {
                    case "16":
                        plist_k = "2A228418A877859A39BA538A2234DD4F";
                        break;
                    case "18":
                        plist_k = "C7276F40044676A508525F2D6E1390B6";
                        break;
                    case "19":
                        plist_k = "D845F5392D8EF2F6DFAF1FF827566B64";
                        break;
                    case "20":
                        plist_k = "407D52E97A940F5AAA5CDE633248673D";
                        break;
                    case "21":
                        plist_k = "48E95829EC2D03E2CE4262172C4EC7F8";
                        break;
                    case "2":
                        plist_k = "8123BC52C20EC976C8F306BFC2A2B386";
                        break;
                    case "26":
                        plist_k = "959F53073A38CD4BD32AF260C8ED351A";
                        break;
                    case "35":
                        plist_k = "94251309b71e2ef083c2617ad984bc13";
                        break;
                    case "5":
                        plist_k = "48BF5F2AEA4A8B40F8D293A646412ED4";
                        break;
                }           
            }

            //取得da值
            var plist_da = window.btoa(acc)

            return "?site="+site+"&k="+plist_k+"&da="+plist_da
        }

        function downloadPlist(account, site, version, domain, type) {
            // 取得當前網頁的網域
            const currentDomain = window.location.origin;
            
            // 替換成實際的 plist 生成頁面 URL
            const dynamicPlistURL = `https://dynamic-plist.onrender.com/generatePlist?account=${account}&site=${site}&version=${version}&domain=${domain}&type=${type}`;

            // 創建包含 itms-services 的按鈕
            const installButton = document.createElement("a");
            installButton.href = `itms-services://?action=download-manifest&amp;url=${encodeURIComponent(dynamicPlistURL)}`;
            installButton.textContent = "Install App";
            document.body.appendChild(installButton);
            // Trigger a click on the link to start the download
            installButton.click();

            // Remove the link from the body
            document.body.removeChild(installButton);
        }

        // 產生Plist提供下載
        function generatePlist(account, site, version, domain, type) {

            const build = "1";

            // 生成隨機數字
            const randomTimestamp = Date.now(); // 或使用 Math.random() * 1000000000（或其他方法）生成您想要的數字範圍


            // ipa URL
            const ipa_url = (() => {
                const ipaNameMapping = {
                    16: "ku.ipa",
                    18: "ku.ipa",
                    19: "ku.ipa",
                    20: "ku.ipa",
                    2: "ts.ipa",
                    5: "ts.ipa",
                    21: "ts.ipa",
                    26: "ts.ipa",
                    35: "ts.ipa",
                    // 添加其他可能的 site 映射
                };

                const ipaName = ipaNameMapping[site] || "default.ipa";
                return `https://${domain}/appVersion/iosVersion/${site}/${version}/${ipaName}?_t=${randomTimestamp}`;
            })();


            // icon名稱
            const icon_path = (() => {
                const iconFileMapping = {
                    16: "cn/ku_vip_icon.png",
                    18: "vn/ku_vip_icon.png",
                    19: "th/ku_vip_icon.png",
                    20: "th/ku_vip_icon.png",
                    2: "zh/tha_icon.png",
                    5: "vi/tha_icon.pnga",
                    21: "zh/leo_icon.png",
                    26: "cn/bet9_icon.png",
                    35: "cn/bet8_icon.png",
                    // 添加其他可能的 site 映射
                };

                const iconName = iconFileMapping[site] || "cn/ku_vip_icon.png";
                return `https://${domain}/images/${iconName}?_t=${randomTimestamp}`;
            })();


            // app Apple ID
            const bundleId = (function () {
                return function (account, site, type) {

                    const atIndex = account.indexOf('@');
                    const extractUsername = atIndex !== -1 ? account.slice(0, atIndex) : account;
                    const baseString = `com.${extractUsername}.app${site}`;
                    
                    // 根據 type 動態添加後綴
                    const resultString = type === 'dev' ? `${baseString}.dev` :
                                        type === 'uat' ? `${baseString}.uat` :
                                        baseString;

                    return resultString;
                };
            })();

            // app名稱
            const appName = `KUBET v${version}`;
            

            const plistContent = `<?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
            <plist version="1.0">
            <dict>
                <key>items</key>
                <array>
                    <dict>
                        <key>assets</key>
                        <array>
                            <dict>
                                <key>kind</key>
                                <string>software-package</string>
                                <key>url</key>
                                <string>${ipa_url}</string>
                            </dict>
                            <dict>
                                <key>kind</key>
                                <string>display-image</string>
                                <key>needs-shine</key>
					            <true/>
                                <key>url</key>
                                <string>${icon_path}</string>
                            </dict>
                        </array>
                        <key>metadata</key>
                        <dict>
                            <key>bundle-identifier</key>
                            <string>${bundleId(account, site, type)}</string>
                            <key>bundle-version</key>
                            <string>${version}</string>
                            <key>kind</key>
                            <string>software</string>
                            <key>title</key>
                            <string>${appName}</string>
                        </dict>
                    </dict>
                </array>
            </dict>
            </plist>`;


            // 將 plist 內容轉換為 data URI
            const dataURI = `data:application/xml;base64,${btoa(plistContent)}`;

            // 動態生成包含動態 plist URL 的按鈕
            const downloadButton = document.createElement("a");
            downloadButton.href = `itms-services://?action=download-manifest&amp;url=itms-services://?action=download-manifest&amp;url=${encodeURIComponent(dataURI)}`;
            downloadButton.textContent = "Download App";
            document.body.appendChild(downloadButton);
            // Trigger a click on the link to start the download
            downloadButton.click();

            // Remove the link from the body
            document.body.removeChild(downloadButton);
        }


    </script>

<div></div>

</body></html>